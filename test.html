<!DOCTYPE html>
<html>
<body>

<h1>Tidybib</h1>

<p>Tidy your bib file</p>

<p style="width: 50%; float: left; margin-top: 0px;">
    <label style="display: block;">Old revision</label>
    <textarea id="field1" name="old" cols="80" rows="25" style="resize:none;"></textarea>
</p>
<p style="width: 49%; float: right; margin-top: 0px;">
    <label style="display: block;">New revision</label>
    <textarea id="field2" name="new" cols="80" rows="25" style="resize:none;"></textarea>
</p>

<br>

<button class="button" onclick="tidybib()">tidy</button> <br><br>

<p>An example:</p>

<img src="old.png" title="Old version" border="1"><br>
<img src="new.png" title="New version" border="1">

<script>

const regex = /(%.*)/gmi;
const comments = /(%.*)/gmi;
const string = /(@string{[\s\S]*?})(?=[ \\\n]*[@%])/gmi;
const inproceedings = /(@inproceedings{[\s\S]*?})(?=[ \\\n]*[@%])/gmi;
const proceedings = /(@proceedings{[\s\S]*?})(?=[ \\\n]*[@%])/gmi;
const misc = /(@misc{[\s\S]*?})(?=[ \\\n]*[@%])/gmi;
const article = /(@article{[\s\S]*?})(?=[ \\\n]*[@%])/gmi;
const book = /(@book{[\s\S]*?})(?=[ \\\n]*[@%])/gmi;
const incollection = /(@incollection{[\s\S]*?})(?=[ \\\n]*[@%])/gmi;

const head_inproceedings = /(@inproceedings{[\s\S]*?})(?=[ \\\n]*[@%])/gmi;
const head_proceedings = /(@proceedings{[\s\S]*?,)(?=[ \\\n]*)/gmi;
const head_misc = /(@misc{[\s\S]*?,)(?=[ \\\n]*)/gmi;
const head_article = /(@article{[\s\S]*?,)(?=[ \\\n]*)/gmi;
const head_book = /(@book{[\s\S]*?,)(?=[ \\\n]*)/gmi;
const head_incollection = /(@incollection{[\s\S]*?,)(?=[ \\\n]*)/gmi;

const author = /(?<!\w)(author[\s\S]*?[}\"],)/gmi;
const title = /(?<!\w)(title[\s\S]*?[}\"],)/gmi;
const journal = /(?<!\w)(journal[\s\S]*?[}\"],)/gmi;
const year = /(?<!\w)(year[\s\S]*?[}\"],)/gmi;
const volume = /(?<!\w)(volume[\s\S]*?[}\"],)/gmi;
const number = /(?<!\w)(number[\s\S]*?[}\"],)/gmi;
const pages = /(?<!\w)(pages[\s\S]*?[}\"],)/gmi;
const month = /(?<!\w)(month[\s\S]*?[}\"],)/gmi;
const doi = /(?<!\w)(doi[\s\S]*?[}\"],)/gmi;
const editor = /(?<!\w)(editor[\s\S]*?[}\"],)/gmi;
const publisher = /(?<!\w)(publisher[\s\S]*?[}\"],)/gmi;
const series = /(?<!\w)(series[\s\S]*?[}\"],)/gmi;
const organization = /(?<!\w)(organization[\s\S]*?[}\"],)/gmi;
const address = /(?<!\w)(address[\s\S]*?[}\"],)/gmi;
const edition = /(?<!\w)(edition[\s\S]*?[}\"],)/gmi;
const booktitle = /(?<!\w)(booktitle[\s\S]*?[}\"],)/gmi;
const howpublished = /(?<!\w)(howpublished[\s\S]*?[}\"],)/gmi;

const content = /(?<=[{\"])([\s\S]*)(?=[}\"])/gmi;

const outhead = "% This file is generated by Tidybib\n\n";

const inproceedings_regex = {
    "item": inproceedings,
    "head": head_inproceedings,
    "content": content,

    "author": author,
    "title": title,
    "booktitle": booktitle,
    "year": year,
    "editor": editor,
    "volume": volume,
    "number": number,
    "series": series,
    "pages": pages,
    "publisher": publisher,
    "doi": doi
}

const proceedings_regex = {
    "item": proceedings,
    "head": head_proceedings,
    "content": content,

    "title": title,
    "year": year,
    "editor": editor,
    "publisher": publisher,
    "volume": volume,
    "number": number,
    "series": series,
    "organization": organization,
    "address": address,
    "month": month
}

const misc_regex = {
    "item": misc,
    "head": head_misc,
    "content": content,

    "author": author,
    "title": title,
    "howpublished": howpublished,
    "year": year,
    "month": month
}

const book_regex = {
    "item": book,
    "head": head_book,
    "content": content,

    "author": author,
    "title": title,
    "year": year,
    "edition": edition,
    "publisher": publisher,
    "address": address
}

const article_regex = {
    "item": article,
    "head": head_article,
    "content": content,

    "author": author,
    "title": title,
    "journal": journal,
    "year": year,
    "volume": volume,
    "number": number,
    "pages": pages,
    "doi": doi
}

const incollection_regex = {
    "item": incollection,
    "head": head_incollection,
    "content": content,

    "author": author,
    "title": title,
    "booktitle": booktitle,
    "pages": pages,
    "year": year
}

function tidybib() {
    var old_version = document.getElementById("field1").value + "\n%";
    // document.getElementById("field2").value = outhead;

    m = article.exec(old_version);
    // m.forEach((match, groupIndex) => {
    //     document.getElementById("field2").value += match;
    // });
    var x = outhead;
    for (i=0; i<m.length; i++) {
        x += m[i];
    }
    document.getElementById("field2").value += x;
}

</script>

</body>
</html>
